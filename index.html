<!DOCTYPE html>
<html lang="vi" class="locked-html">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gallery ‚Äì Danh m·ª•c JPG & MP4</title>
<style>
:root { --bg:#0f1115; --card:#151922; --text:#e8edf2; --muted:#a8b3c7; --border:#20283a; --accent:#4ea1ff; }
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* ===== Header / Layout ===== */
header{position:sticky;top:0;background:#10131b;border-bottom:1px solid var(--border);z-index:10}
.header-inner{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
h1{font-size:18px;margin:0}
.controls{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
#q{background:#0e131e;border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);min-width:240px}
main{max-width:1200px;margin:16px auto 56px;padding:0 16px}
#summary{color:var(--muted);font-size:13px;margin:0 0 10px}
.section{margin:24px 0}
.section h2{margin:0 0 8px;font-size:18px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.preview{display:block;width:100%;height:260px;overflow:hidden;background:#0b0f18}
.preview img,.preview video{width:100%;height:100%;object-fit:contain;display:block}
.meta{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;color:var(--muted);font-size:12px}
.meta code{color:#c7d2fe;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;word-break:break-all}
.notice{background:#172033;border:1px solid var(--border);border-radius:8px;padding:8px 10px;margin:8px 0 16px;color:var(--muted);font-size:13px}
footer{max-width:1200px;margin:28px auto 40px;padding:0 16px;color:var(--muted);font-size:12px}

/* ===== Lock overlay ===== */
body.locked { overflow: hidden; }
body.locked header, body.locked main, body.locked footer {
  filter: blur(14px) brightness(0.6);
  pointer-events: none;
  user-select: none;
}
#gate {
  position: fixed; inset: 0; z-index: 9999;
  display: flex; align-items: center; justify-content: center;
  background: rgba(6,10,18,0.66);
}
#gate .box{
  width: min(92vw, 420px);
  background: #0f1422;
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,.45);
}
#gate h2{margin:0 0 10px; font-size:20px}
#gate p{margin:0 0 14px; color:var(--muted); font-size:13px}
.ginput{display:flex; gap:8px}
.ginput input{
  flex:1; padding:10px 12px; border-radius:10px;
  border:1px solid var(--border); background:#0c1120; color:#fff;
  font-size:14px; outline:none;
}
.ginput button{
  padding:10px 14px; border-radius:10px; border:1px solid #345b95;
  background: linear-gradient(180deg,#1a3a6a,#13284a);
  color:#d9e6ff; cursor:pointer; font-weight:700;
}
.ghint{margin-top:10px; font-size:12px; color:#8aa7d1}
.hidden{display:none!important}
.badge{padding:2px 6px;border-radius:999px;background:#263142;color:#bfe2ff;font-size:12px}
.meta-left{display:flex;gap:8px;align-items:center;min-width:0}
</style>
</head>

<body class="locked">
  <!-- ===== Gate / Login Overlay ===== -->
  <div id="gate" role="dialog" aria-modal="true">
    <div class="box">
      <h2>üîí ƒêƒÉng nh·∫≠p</h2>
      <p>Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ v√†o trang.</p>
      <div class="ginput">
        <input id="pw" type="password" placeholder="M·∫≠t kh·∫©u" autocomplete="current-password" />
        <button id="btn">Login</button>
      </div>
      <div class="ghint">G·ª£i √Ω: vi·∫øt HOA/TH∆Ø·ªúNG ch√≠nh x√°c.</div>
    </div>
  </div>

  <!-- ===== Real page content below (blurred when locked) ===== -->
  <header>
    <div class="header-inner">
      <h1>Gallery ‚Äì Danh m·ª•c JPG &amp; MP4</h1>
      <div class="controls">
        <input id="q" type="search" placeholder="T√¨m t√™n file‚Ä¶ (vd: 001, .mp4, .jpg)"/>
      </div>
    </div>
  </header>

  <main>
    <div class="notice">
      M·ªói th∆∞ m·ª•c c·∫•p 1 l√† <b>danh m·ª•c</b>. Trang ƒë·ªçc danh s√°ch file t·ª´ <code>manifest.json</code> (build tr∆∞·ªõc khi push).
      N·∫øu c√≥ <code>r2-map.json</code>, c√°c file l·ªõn s·∫Ω t·ª± chuy·ªÉn sang Cloudflare R2 nh∆∞ng v·∫´n gi·ªØ path hi·ªÉn th·ªã.
    </div>
    <p id="summary">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</p>
    <div id="content"></div>
  </main>

  <footer>
    Nh·∫•n v√†o th·∫ª ƒë·ªÉ m·ªü file trong tab m·ªõi. (Ngu·ªìn: <span class="badge">REPO</span> ho·∫∑c <span class="badge">R2</span>)
  </footer>

<script>
/* ===== Password Gate ===== */
const RICK = 'https://youtu.be/dQw4w9WgXcQ?si=YSKtsyxDx_psOnb7';
const REQUIRED = 'MANHWA'; // m·∫≠t kh·∫©u

const gate = document.getElementById('gate');
const body = document.body;
const pw   = document.getElementById('pw');
const btn  = document.getElementById('btn');

// n·∫øu ƒë√£ m·ªü trong session n√†y th√¨ b·ªè kho√°
if (sessionStorage.getItem('gateOK') === '1') {
  gate.classList.add('hidden');
  body.classList.remove('locked');
} else {
  setTimeout(()=>pw.focus(), 50);
}

function tryLogin(){
  const val = (pw.value || '').trim();
  if (val === REQUIRED) {
    sessionStorage.setItem('gateOK', '1');
    gate.classList.add('hidden');
    body.classList.remove('locked');
  } else {
    window.location.href = RICK; // sai m·∫≠t kh·∫©u ‚Üí ra ngo√†i
  }
}
btn.addEventListener('click', tryLogin);
pw.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ tryLogin(); }});

/* ===== Gallery (JPG & MP4) + R2 mapping ===== */
const IMG_EXT = new Set(['.jpg']);   // ch·ªâ JPG
const VID_EXT = new Set(['.mp4']);   // ch·ªâ MP4
const q = document.getElementById('q');
const content = document.getElementById('content');
const summary = document.getElementById('summary');

/** r2Map: { "Fall1/001.mp4": "https://...R2.../Fall1/001.mp4", ... } */
let r2Map = Object.create(null);

function extOf(n){ const i=n.lastIndexOf('.'); return i>=0 ? n.slice(i).toLowerCase() : ''; }
function isImg(n){ return IMG_EXT.has(extOf(n)); }
function isVid(n){ return VID_EXT.has(extOf(n)); }

/** Tr·∫£ v·ªÅ {url, origin} ‚Äì n·∫øu c√≥ trong r2Map th√¨ d√πng URL R2 */
function resolveURL(relPath){
  // relPath ki·ªÉu "Fall1/001.mp4"
  const mapped = r2Map[relPath] || null;
  if (mapped) return { url: mapped, origin: 'R2' };
  return { url: relPath, origin: 'REPO' };
}

function createCard(relPath){
  const {url, origin} = resolveURL(relPath);
  const isImage = isImg(relPath);
  const isVideo = isVid(relPath);

  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.name = relPath.toLowerCase();

  const wrap = document.createElement('a');
  wrap.className = 'preview';
  wrap.href = url;
  wrap.target = '_blank'; wrap.rel='noopener';

  if(isImage){
    const img = document.createElement('img');
    img.loading='lazy'; img.src=url; img.alt=relPath;
    wrap.appendChild(img);
  }else{
    const v = document.createElement('video');
    v.src=url; v.controls=true; v.preload='metadata';
    wrap.appendChild(v);
  }

  const meta = document.createElement('div'); meta.className='meta';
  const left = document.createElement('div'); left.className='meta-left';
  const code = document.createElement('code'); code.textContent = relPath;
  const badge = document.createElement('span'); badge.className='badge'; badge.textContent = origin;
  left.append(code, badge);
  const span = document.createElement('span'); span.textContent = isImage ? 'image' : 'video';
  meta.append(left, span);

  card.append(wrap, meta);
  return card;
}

function render(manifest, term=''){
  content.innerHTML='';
  const cats = Object.keys(manifest).sort();
  let total=0, nImg=0, nVid=0;
  for(const cat of cats){
    // manifest[cat] ch·ª©a c√°c path t∆∞∆°ng ƒë·ªëi: "Fall1/001.jpg", "Fall1/001.mp4", ...
    const files = (manifest[cat]||[])
      .filter(p => (!term || p.toLowerCase().includes(term)))
      .filter(p => isImg(p) || isVid(p));

    if(!files.length) continue;
    const sec = document.createElement('section');
    sec.className = 'section';
    const h2 = document.createElement('h2'); h2.textContent = cat;
    const grid = document.createElement('div'); grid.className='grid';

    for(const f of files){
      grid.appendChild(createCard(f));
      total++; if(isImg(f)) nImg++; else if(isVid(f)) nVid++;
    }
    sec.append(h2, grid);
    content.appendChild(sec);
  }
  summary.textContent = total ? `T·ªïng ${total} file (${nImg} ·∫£nh, ${nVid} video).` : 'Kh√¥ng c√≥ file ph√π h·ª£p.';
}

async function fetchJSON(url){
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) return null;
    return await res.json();
  }catch{ return null; }
}

async function load(){
  // 1) T·∫£i r2-map.json (n·∫øu c√≥)
  const r2 = await fetchJSON('r2-map.json');
  if (r2 && Array.isArray(r2)) {
    // ƒë·ªãnh d·∫°ng t·ª´ script: [{path:"Fall1/001.mp4", r2:"https://..."}, ...]
    for(const it of r2){
      if(it && it.path && it.r2) r2Map[it.path] = it.r2;
    }
  }

  // 2) T·∫£i manifest.json (b·∫Øt bu·ªôc)
  const manifest = await fetchJSON('manifest.json');
  if(!manifest){
    summary.textContent = 'L·ªói: kh√¥ng t√¨m th·∫•y manifest.json. H√£y build manifest v√† push l·∫°i.';
    return;
  }

  render(manifest);
  q.addEventListener('input', () => {
    const term = q.value.trim().toLowerCase();
    render(manifest, term);
  });
}

load();
</script>
</body>
</html>